name: CI
on: push
jobs:
  build:
    # Installs Yarn (npm alternative) to run jest tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install modules
        run: yarn
      - name: Run tests
        run: yarn test
      - name: Check linting and formatting
        run: yarn lint:check

      - name: Create Coverage
        run: node ./node_modules/jest/bin/jest.js --coverage

      - name: Coveralls- post coverage report
        uses: coverallsapp/github-action@master
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # Autogenerate jsDocs and output files to ./jsdocs
      - name: Generate jsDocs
        uses: andstor/jsdoc-action@v1.2.1
        with:
          source_dir: ./source/scripts
          recurse: true
          output_dir: ./jsdocs

      # Push generated files onto a new branch called gh-pages
      - name: Deploy jsDocs
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./jsdocs

      - name: HTML5 Validator
        uses: Cyb3r-Jak3/html5validator-action@v7.2.0
        with:
          root: source/
          css: true
      # Automatic Pull Request for JSDocs
      # - name: automerge
      # on:
      #   pull_request:
      #     types:
      #       - labeled
      #       - unlabeled
      #       - synchronize
      #       - opened
      #       - edited
      #       - ready_for_review
      #       - reopened
      #       - unlocked
      #   pull_request_review:
      #     types:
      #       - submitted
      #   check_suite:
      #     types:
      #       -completed
      #   status: {}
      # jobs:
      #   automerge:
      #     runs-on: ubuntu-latest
      #     steps:
      #       - id: automerge
      #         name: automerge
      #         uses: "pascalgn/automerge-action@v0.15.5"
      #         env:
      #     GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      # Merge gh-pages into main after another PR is merged onto main
      - name: checkout
        uses: actions/checkout@v2
      - name: merge
        uses: mtanzi/action-automerge@v1
        id: merge
        with: 
          github_token: ${{ github.token }}
          source: 'gh-pages'
          target: 'main'
####