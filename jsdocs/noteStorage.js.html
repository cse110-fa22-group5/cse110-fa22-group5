<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: noteStorage.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: noteStorage.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const DBNAME = 'NotesDB';
const OBJECT_STORE_NAME = 'NotesOS';
let db;

/**
 * Sets up and returns a reference to our IndexedDB notes storage.
 * @returns A reference to our IndexedDB notes storage.
 */
export function initializeDB(indexedDB) {
    return new Promise((resolve, reject) => {
        if (db) {
            resolve(db);
            return;
        }
        const openRequest = indexedDB.open(DBNAME, 1);
        openRequest.onupgradeneeded = (event) => {
            // Set up the database table if it hasn't been initialized yet.
            db = event.target.result;
            const objectStore = db.createObjectStore(OBJECT_STORE_NAME, { keyPath: 'uuid', autoIncrement: true});
            objectStore.createIndex('notes', 'notes', { unique: false });
        }
        openRequest.onsuccess = (event) => {
            db = event.target.result;
            resolve(db);
        }     
        openRequest.onerror = (event) => {
            reject(`Error opening database! ${event.target.errorCode}`)
        }
    });
}

/**
 * Gets all notes stored in 'NotesDB' from IndexedDB.
 * @param {*} db The initialized indexedDB object
 * @returns A list of note objects.
 */
export function getNotesFromStorage(db) {
    return new Promise((resolve, reject) => {
        const objectStore = db.transaction(OBJECT_STORE_NAME).objectStore(OBJECT_STORE_NAME);
        const notes = []
        let getNotesRequest = objectStore.openCursor();
        getNotesRequest.onsuccess = (event) => {
            // Iterate through all the notes received and add them to be returned.
            let cursor = event.target.result;
            if (cursor) {
                notes.push(cursor.value);
                cursor.continue();
            } else {
                resolve(notes);
            }
        }
        getNotesRequest.onerror = (event) => {
            reject(`Error fetching notes from storage: ${event.target.errorCode}`)
        }
    });
}

/**
 * Gets a single note from storage, if it exists.
 * @param {*} db The initialized indexedDB object.
 * @param {*} id UUID of the note.
 * @returns The note object stored with the given UUID.
 */
export function getNoteFromStorage(db, id) {
    return new Promise((resolve, reject) => {
        const objectStore = db.transaction(OBJECT_STORE_NAME).objectStore(OBJECT_STORE_NAME);
        const getNoteRequest = objectStore.get(id);
        getNoteRequest.onsuccess = (e) => {
            resolve(getNoteRequest.result);
        }
        getNoteRequest.onerror = (e) => {
            reject(`Error fetching note with id ${id} from storage.`);
        }
    });
}

/**
 * Takes the given note and saves it to the database. To make a new note,
 * pass in a Note object where the UUID is undefined and a new note will be made.
 * @param {*} db The initialized indexedDB object.
 * @param {*} note The note object to save.
 * @returns Promise&lt;int> The UUID of the newly saved note.
 */
export function saveNoteToStorage(db, note) {
    if (!note.uuid) {
        return new Promise((resolve, reject) => {
            const objectStore = db.transaction(OBJECT_STORE_NAME, 'readwrite').objectStore(OBJECT_STORE_NAME);
            const saveNoteRequest = objectStore.add(note);
            saveNoteRequest.onsuccess = (event) => {
                console.log(`Successfully saved note with uuid ${saveNoteRequest.result}`);
                console.log(saveNoteRequest.result);
                resolve();
            }
            saveNoteRequest.onerror = (event) => {
                reject(`Error saving new note to storage`)
            }
        });
    } else {
        return new Promise((resolve, reject) => {
            const objectStore = db.transaction(OBJECT_STORE_NAME, 'readwrite').objectStore(OBJECT_STORE_NAME);
            const saveNoteRequest = objectStore.put(note);
            saveNoteRequest.onsuccess = (event) => {
                console.log(`Successfully saved note with uuid ${saveNoteRequest.result}`);
                resolve(saveNoteRequest.result);
            }
            saveNoteRequest.onerror = (event) => {
                reject(`Error saving note with id ${note.uuid} to storage`)
            }
        });
    }
}

/**
 * Takes the given note and deletes it from storage.
 * @param {*} db The initialized indexedDB object.
 * @param {*} note The note object to delete.
 * @returns Promise&lt;void>
 */
function deleteNoteFromStorage(db, note) {
    return new Promise((resolve, reject) => {
        const objectStore = db.transaction(OBJECT_STORE_NAME, 'readwrite').objectStore(OBJECT_STORE_NAME);
        const deleteNoteRequest = objectStore.delete(note.uuid);
        deleteNoteRequest.onsuccess = (event) => {
            console.log(`Successfully deleted note with uuid ${saveNoteRequest.result}`);
            resolve();
        }
        deleteNoteRequest.onerror = (event) => {
            reject(`Error deleting note with id ${note.uuid} from storage`)
        }
    });
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="dashboardRow.html">dashboardRow</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addNotesToDocument">addNotesToDocument</a></li><li><a href="global.html#deleteNoteFromStorage">deleteNoteFromStorage</a></li><li><a href="global.html#getNoteFromStorage">getNoteFromStorage</a></li><li><a href="global.html#getNotesFromStorage">getNotesFromStorage</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initEventHandler">initEventHandler</a></li><li><a href="global.html#initializeDB">initializeDB</a></li><li><a href="global.html#saveNoteToStorage">saveNoteToStorage</a></li><li><a href="global.html#sortNotesByTime">sortNotesByTime</a></li><li><a href="global.html#sortNotesByTitle">sortNotesByTitle</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.0</a> on Wed Nov 23 2022 22:21:25 GMT-0800 (Pacific Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
